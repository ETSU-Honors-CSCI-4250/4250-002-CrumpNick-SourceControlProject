name: Notify Discord on PR and Review

on:
  pull_request:
    types: [opened, closed, reopened]
    branches:
      - main
  pull_request_review:
    types: [submitted]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key C99B11DEB97541F0
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh -y

      - name: Count Approvals and Notify
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          REQUIRED_APPROVALS=2

          # Authenticate with GitHub CLI
          echo $GITHUB_TOKEN | gh auth login --with-token

          # Get all reviews on the PR
          REVIEWS_JSON=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews)

          # Extract approved reviewers (last review per user counts)
          APPROVED_COUNT=$(echo "$REVIEWS_JSON" | jq '[group_by(.user.login)[] | last | select(.state == "APPROVED")] | length')

          if [[ "$APPROVED_COUNT" -ge "$REQUIRED_APPROVALS" ]]; then
            STATUS_MSG="$APPROVED_COUNT/$REQUIRED_APPROVALS Approvals â€“ Ready to Merge"
            COLOR=3066993  # Green
          else
            STATUS_MSG="$APPROVED_COUNT/$REQUIRED_APPROVALS Approvals"
            COLOR=15105570  # Yellowish
          fi

          TITLE="Code Review Update"
          DESCRIPTION="[PR #$PR_NUMBER](https://github.com/$REPO/pull/$PR_NUMBER) - **${{ github.event.pull_request.title }}**\n$STATUS_MSG"

          curl -H "Content-Type: application/json" -X POST -d '{
            "username": "GitHub Bot",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "'"$TITLE"'",
              "description": "'"$DESCRIPTION"'",
              "color": '"$COLOR"',
              "fields": [
                { "name": "Repository", "value": "'"$REPO"'", "inline": true },
                { "name": "Reviewed By", "value": "${{ github.event.review.user.login }}", "inline": true }
              ]
            }]
          }' $DISCORD_WEBHOOK
